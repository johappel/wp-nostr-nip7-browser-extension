<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WP Nostr Signer</title>
  <link rel="stylesheet" href="popup.css">
</head>
<body>
  <main class="app-shell">
    <!-- Header -->
    <header class="app-header">
      <div class="header-title">
        <h1 id="app-title">WP Nostr Signer</h1>
        <span class="connection-status" id="connection-status">
          <span class="status-dot"></span>
          <span class="status-text">Connected</span>
        </span>
      </div>
    </header>

    <!-- User Hero (klickbar ‚Üí Profil-Dialog) -->
    <section class="user-hero" id="user-hero" role="button" tabindex="0" aria-label="Profil-Details √∂ffnen">
      <div class="hero-avatar" id="hero-avatar">
        <!-- Avatar wird via JS gesetzt -->
      </div>
      <div class="hero-info">
        <div class="hero-name" id="hero-name">Wird geladen...</div>
        <div class="hero-nip05" id="hero-nip05">-</div>
      </div>
      <div class="hero-chevron">‚Ä∫</div>
    </section>

    <!-- View Container -->
    <div class="view-container">
      <!-- View: Home -->
      <div class="view active" id="view-home">
        <div class="view-header">
          <h2>Kontakte</h2>
          <div class="view-header-actions">
            <button id="refresh-contacts" class="btn-secondary btn-small" type="button" title="Kontakte neu laden">‚Üª</button>
          </div>
        </div>
        
        <!-- Search/Filter -->
        <div class="contact-search-row">
          <div class="contact-search">
            <input id="contact-search-input" type="text" placeholder="Kontakte durchsuchen..." />
          </div>
          <button id="toggle-add-contact" class="btn-secondary btn-small" type="button">+ Kontakt</button>
        </div>

        <div class="contact-add-form" id="contact-add-form" hidden>
          <input id="add-contact-input" type="text" placeholder="Pubkey (hex oder npub)" />
          <button id="add-contact-submit" class="btn-secondary" type="button">Zu meinen Kontakten hinzuf√ºgen</button>
        </div>
        
        <!-- Source Filter -->
        <div class="contact-filter">
          <button class="filter-btn active" data-source="all">Alle</button>
          <button class="filter-btn" data-source="nostr">Nostr</button>
          <button class="filter-btn" data-source="wordpress">WordPress</button>
        </div>
        
        <!-- Contact List -->
        <div class="contact-list" id="contact-list">
          <div class="contact-loading">
            <p class="empty">Kontakte werden geladen...</p>
          </div>
        </div>
      </div>

      <!-- View: Conversation -->
      <div class="view" id="view-conversation">
        <div class="conversation-header">
          <button class="btn-back" id="conversation-back" title="Zur√ºck">‚Üê</button>
          <img class="conversation-avatar" id="conversation-avatar" src="" alt="" data-fallback="avatar" />
          <div class="conversation-identity">
            <span class="conversation-name" id="conversation-name"></span>
            <div class="conversation-pubkey-row">
              <code class="conversation-pubkey" id="conversation-pubkey">-</code>
              <button class="conversation-pubkey-copy" id="conversation-pubkey-copy" type="button" title="Pubkey kopieren">
                Kopieren
              </button>
            </div>
          </div>
        </div>
        
        <!-- Optional: Relay Info -->
        <div id="conversation-relays" class="relay-status-row" style="display:none;"></div>

        <div class="message-list" id="message-list">
          <!-- Wird dynamisch bef√ºllt -->
        </div>
        
        <div class="message-input-bar">
          <textarea id="message-input" placeholder="Nachricht..." rows="1"></textarea>
          <button class="btn-primary btn-send" id="send-message">Senden</button>
        </div>
      </div>

      <!-- View: Keys -->
      <div class="view" id="view-keys">
        <div class="view-header">
          <h2>Schl√ºssel-Verwaltung</h2>
        </div>

        <!-- Protection Mode -->
        <div id="protection-row" class="key-section"></div>

        <!-- Export Section -->
        <div class="key-section">
          <h3>Exportieren</h3>
          <div class="key-row key-row-export">
            <button id="export-key" class="btn-secondary" type="button">Exportieren</button>
            <input id="backup-output" class="backup-output" type="password" readonly placeholder="nsec1... (Export)" />
            <button id="backup-output-toggle" class="btn-copy" type="button" title="Anzeigen/Verbergen">üëÅ</button>
            <button id="backup-output-copy" class="btn-copy" type="button">Kopieren</button>
            <button id="backup-download" class="btn-secondary" type="button" title="Schl√ºsseldatei lokal sichern">‚¨á Datei</button>
          </div>
        </div>

        <!-- Import Section -->
        <div class="key-section">
          <h3>Importieren</h3>
          <div class="key-row key-row-import">
            <input id="import-nsec" type="text" placeholder="nsec1... (Import)" />
            <button id="import-key" class="btn-secondary" type="button">Importieren</button>
          </div>
        </div>

        <!-- Create Section -->
        <div class="key-section">
          <h3>Neue Schl√ºssel erstellen</h3>
          <p class="hint warn compact-hint">Warnung: Erstellen neuer Schl√ºssel ersetzt die aktuelle Identit√§t!</p>
          <div class="key-row key-row-create">
            <button id="create-key" class="btn-danger" type="button">Erstellen</button>
          </div>
        </div>

        <!-- Cloud Backup (Tresor) -->
        <div class="key-section cloud-backup">
          <h3>Schl√ºsselkopie in WordPress</h3>
          <p id="cloud-backup-meta" class="hint">Status wird geladen...</p>
          <div class="backup-actions">
            <button id="backup-enable-cloud" class="btn-secondary" type="button">Speichern/Ersetzen</button>
            <button id="backup-restore-cloud" class="btn-secondary" type="button">Wiederherstellen</button>
            <button id="backup-delete-cloud" class="btn-danger" type="button">L√∂schen</button>
          </div>
        </div>
      </div>

      <!-- View: History -->
      <div class="view" id="view-history">
        <div class="view-header">
          <h2>Aktivit√§tsverlauf</h2>
        </div>
        <div class="history-list" id="history-list">
          <p class="empty">Noch keine Signing-Events vorhanden.</p>
          <p class="hint">Hier werden zuk√ºnftig signierte Aktionen angezeigt.</p>
        </div>
      </div>

      <!-- View: Settings -->
      <div class="view" id="view-settings">
        <div class="view-header">
          <h2>Einstellungen</h2>
        </div>

        <!-- WP-Nostr-Lock -->
        <div class="settings-section">
          <label class="row">
            <input type="checkbox" id="prefer-lock" />
            <span>WP-Nostr-Lock bevorzugen</span>
          </label>
          <p class="hint">Wenn aktiv, versucht die Extension, <code>window.nostr</code> gegen √úberschreiben durch andere Extensions zu sch√ºtzen.</p>
          <p class="hint warn">√Ñnderung wirkt nach Tab-Reload.</p>
        </div>

        <!-- ReLogin-Dauer -->
        <div class="settings-section">
          <h3>ReLogin f√ºr sensible Aktionen</h3>
          <div class="relogin-row">
            <select id="unlock-cache-policy" class="relogin-duration" aria-label="ReLogin-Dauer">
              <option value="off">Immer nachfragen</option>
              <option value="5m">5 Minuten</option>
              <option value="15m">15 Minuten</option>
              <option value="30m">30 Minuten</option>
              <option value="60m">60 Minuten</option>
              <option value="session">Bis Browser-Neustart</option>
            </select>
            <span id="unlock-cache-state" class="state-pill state-inactive">inaktiv</span>
          </div>
          <p id="unlock-cache-hint" class="hint">Gilt f√ºr Signieren sowie Schl√ºssel sichern/wiederherstellen.</p>
        </div>

        <!-- Instance Info -->
        <div class="settings-section">
          <h3>Mitglieder-Instanz</h3>
          <div id="instance-card" class="wp-user-card">
            <p class="empty">Instanz-Informationen werden geladen...</p>
          </div>
        </div>

        <!-- Nachrichten-Relay (f√ºr TASK-19/20) -->
        <div class="settings-section">
          <h3>Nachrichten-Relay</h3>
          <div class="dm-relay-row">
            <input id="dm-relay-url" type="text" placeholder="wss://relay.example.com" />
            <button id="save-dm-relay" class="btn-secondary" type="button">Speichern</button>
          </div>
          <p class="hint">Relay f√ºr DM-Empfang/Versand (Kind 10050 / NIP-17). Leer = verwendet Relay des Gespr√§chspartners.</p>
        </div>

        <!-- DM-Benachrichtigungen -->
        <div class="settings-section">
          <label class="row">
            <input type="checkbox" id="dm-notifications-enabled" />
            <span>Desktop-Benachrichtigungen f√ºr neue Nachrichten</span>
          </label>
          <p class="hint">Zeigt bei eingehenden Direktnachrichten eine System-Benachrichtigung an.</p>
        </div>

        <!-- Sidebar-Modus -->
        <div class="settings-section">
          <label class="row">
            <input type="checkbox" id="open-in-sidebar" />
            <span>Chat in Sidebar √∂ffnen</span>
          </label>
          <p class="hint">Wenn aktiv, √∂ffnet sich beim Klick auf die Extension die native Sidebar/Side-Panel-Ansicht statt des Popups.</p>
          <p class="hint" id="firefox-sidebar-position-hint" hidden>
            Firefox-Hinweis: Die Sidebar-Position (links/rechts) wird vom Browser gesteuert. In den Sidebar-Einstellungen kann "Move Sidebar to Right" aktiviert werden.
          </p>
        </div>

        <!-- Erweitert -->
        <div class="settings-section">
          <h3>Erweitert</h3>
          <div class="wp-user-meta"><strong>Version:</strong> <span id="extension-version">-</span></div>
          <div class="wp-user-meta"><strong>Scope:</strong> <span id="active-scope">-</span></div>
        </div>
      </div>
    </div>

    <!-- Dialog Overlay -->
    <div class="dialog-overlay" id="dialog-overlay" aria-hidden="true">
      <div class="dialog" id="dialog-profile" role="dialog" aria-labelledby="dialog-title">
        <div class="dialog-header">
          <h2 id="dialog-title">Profil-Details</h2>
          <div class="dialog-header-actions">
            <button id="refresh-profile" class="btn-small" type="button" title="Neu laden">‚Üª</button>
            <button class="dialog-close" id="dialog-close" type="button" aria-label="Schlie√üen">‚úï</button>
          </div>
        </div>
        <div class="dialog-content">
          <!-- Profil-Karte -->
          <div id="profile-card" class="wp-user-card">
            <p class="empty">Profil wird geladen...</p>
          </div>
          <p id="profile-hint" class="hint"></p>
          <!-- Publish Button -->
          <div class="dialog-actions">
            <button id="publish-profile" class="btn-primary" type="button">Profil an Nostr senden</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer Navigation -->
    <nav class="footer-nav" id="footer-nav" aria-label="Hauptnavigation">
      <button class="nav-item active" data-view="home" type="button">
        <span class="nav-icon">üè†</span>
        <span class="nav-label">Home</span>
      </button>
      <button class="nav-item" data-view="keys" type="button">
        <span class="nav-icon">üîë</span>
        <span class="nav-label">Keys</span>
      </button>
      <button class="nav-item" data-view="history" type="button">
        <span class="nav-icon">üïê</span>
        <span class="nav-label">History</span>
      </button>
      <button class="nav-item" data-view="settings" type="button">
        <span class="nav-icon">‚öôÔ∏è</span>
        <span class="nav-label">Settings</span>
      </button>
    </nav>

    <!-- Status Bar -->
    <p id="status" class="status"></p>
  </main>

  <script src="popup.js"></script>
</body>
</html>
